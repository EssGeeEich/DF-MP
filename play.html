<canvas id="canvas" width="!!canvas_w!!" height="!!canvas_h!!"></canvas><br>
<img id="tilesheet" src="http://i.imgur.com/fUGSAWC.png" alt="tilesheet" style="display: none;">
<script>
var c = document.getElementById("canvas");
var ctx = c.getContext("2d");
var spr=document.getElementById("tilesheet");
var tile_x=16;
var tile_y=16;
var canvas_tile_count=!!size!!;
var map=[];
var color_map=[[0,0,0],[0,0,128],[0,128,0],[0,128,128],
	[128,0,0],[128,0,128],[128,128,0],[192,192,192],
	[128,128,128],[0,0,255],[0,255,0],[0,255,255],
	[255,0,0],[255,0,255],[255,255,0],[255,255,255]];
function color(id){
	var c=color_map[id]
		return "rgb("+c[0]+","+c[1]+","+c[2]+")";
}
function draw_bg( x,y,bg ){
	ctx.fillStyle=color(bg);
	ctx.fillRect(x*tile_x,y*tile_y,tile_x,tile_y);
}
function draw_tile( x,y,tile){
	var sx=tile%16;
	var sy=Math.floor(tile/16);
	ctx.drawImage(spr,sx*tile_x,sy*tile_y,tile_x,tile_y,x*tile_x,y*tile_y,tile_x,tile_y);
}
function color_tiles( x,y,fg,bright ){
	ctx.fillStyle=color(fg+bright*8);
	ctx.fillRect(x*tile_x,y*tile_y,tile_x,tile_y);
}
function draw_map(){
	ctx.clearRect(0, 0, c.width, c.height);
	ctx.globalCompositeOperation="source-over";
	for(var x=0;x<canvas_tile_count;x++)
	for(var y=0;y<canvas_tile_count;y++)
	{
		var t=map[x+y*canvas_tile_count]
		draw_tile(x,y,t[0]);
	}
	
	ctx.globalCompositeOperation="source-atop";
	for(var x=0;x<canvas_tile_count;x++)
	for(var y=0;y<canvas_tile_count;y++)
	{
		var t=map[x+y*canvas_tile_count]
		color_tiles(x,y,t[1],t[3]);
	}
	
	ctx.globalCompositeOperation="destination-over";
	for(var x=0;x<canvas_tile_count;x++)
	for(var y=0;y<canvas_tile_count;y++)
	{
		var t=map[x+y*canvas_tile_count]
		draw_bg(x,y,t[2]);
	}
}
function update_map() {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	if (this.readyState == 4 && this.status == 200) {
		var json_map= JSON.parse(this.responseText);
		map=json_map
		draw_map()
		setTimeout(update_map, 100);
	}
	};
	xhttp.open("GET", "map", true);
	xhttp.send();
}
function get_new_unit() {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	if (this.readyState == 4 && this.status == 200) {
		//do sth?
	}
	};
	xhttp.open("GET", "new_unit", true);
	xhttp.send();
}
var mouse_pos={x:0,y:0}
function move_unit() {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	if (this.readyState == 4 && this.status == 200) {
		//do sth?
	}
	};
	xhttp.open("GET", "move_unit?dx="+mouse_pos.x+"&dy="+mouse_pos.y, true);
	xhttp.send();
}
var mouseIsDown = false;
function update_mouse(e) {
	console.log("Pos:"+e.x+" "+e.y);
	var cx=Math.floor(e.x/tile_x)-(canvas_tile_count-1)/2;
	var cy=Math.floor(e.y/tile_y)-(canvas_tile_count-1)/2;
	console.log("Tile Pos:"+cx+" "+cy);
	mouse_pos={x:cx,y:cy}
}
c.onmousedown = function(e){
	update_mouse(e)
    //dragOffset.x = e.x - mainLayer.trans.x;
    //dragOffset.y = e.y - mainLayer.trans.y;
    move_unit()
    mouseIsDown = true;
}

c.onmouseup = function(e){

    mouseIsDown = false;
}
/* //TODO issue commands each X time
c.onmousemove = function(e){
    if(!mouseIsDown) return;
    update_mouse(e)
    return false;
}
*/
update_map();
/*
	combat report stuff
*/
var combat_log={last_seen:0,text:[]}
function add_max(a,e,m)
{
	return a.concat(e).slice(-m)
}
function update_log(){
	element=document.getElementById("combat_log_div")
	element.innerHTML=""
	combat_log.text.forEach(function (el) {
		element.innerHTML+=el+"<br>"
	})
}
function get_combat_log(){

	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	if (this.readyState == 4 && this.status == 200) {
		var json_report= JSON.parse(this.responseText);
		combat_log.last_seen=json_report.current_count
		var print_lines=10
		combat_log.text=add_max(combat_log.text,json_report.log,print_lines)
		update_log()
		setTimeout(get_combat_log, 200);
	}
	};
	xhttp.open("GET", "get_report_log?last_seen="+combat_log.last_seen, true);
	xhttp.send();
}
get_combat_log()
</script>
<button onclick="location.href = 'new_unit';">Ask for new unit</button> 
<div id="combat_log_div">

</div>


