
<canvas id="canvas" width="!!canvas_w!!" height="!!canvas_h!!"></canvas>
<div>
  <button type="button" onclick="view_dz+=1">Look up</button>
  <button type="button" onclick="view_dz=0">Reset</button>
  <button type="button" onclick="view_dz-=1">Look down</button>
</div>
<br>
<img id="tilesheet" src="http://i.imgur.com/fUGSAWC.png" alt="tilesheet" style="display: none;">
<script src="map.js"></script>
<script>

setup_map("canvas","tilesheet",16,16,!!size!!)
var c = document.getElementById("canvas");
var view_dz=0;

var movement={
	Numpad8:[0,-1],
	Numpad7:[-1,-1],
	Numpad4:[-1,0],
	Numpad1:[-1,1],
	Numpad2:[0,1],
	Numpad3:[1,1],
	Numpad6:[1,0],
	Numpad9:[1,-1]
}
function isNil(value) {
  return value == undefined;
}
var cur_movement
document.onkeydown=function (key) {
	cur_movement=movement[key.code]
}
document.onkeyup=function (key) {
	cur_movement=null
}
function key_movement(){
	if(!isNil(cur_movement))
	{
		move_unit(cur_movement[0],cur_movement[1],view_dz,function () {
			setTimeout(key_movement, 100);
		})
	}
	else
	{
		setTimeout(key_movement, 100);
	}
}
key_movement()
function update_map() {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	if (this.readyState == 4) {
		if(this.status==200)
		{
			var json_map= JSON.parse(this.responseText);
			draw_map(json_map)
		}
		setTimeout(update_map, 100);
	}
	};
	xhttp.open("GET", "map?dz="+view_dz, true);
	xhttp.send();
}
var mouse_pos={x:0,y:0}
function move_unit(dx,dy,dz,on_done) {
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	if (this.readyState == 4 ) {
		if(!isNil(on_done))
			on_done(this.status == 200);
	}
	};
	xhttp.open("GET", "move_unit?dx="+dx+"&dy="+dy+"&dz="+dz, true);
	xhttp.send();
}
var mouseIsDown = false;
function update_mouse(e) {
	var cx=Math.floor(e.x/tile_x)-(canvas_tile_count-1)/2;
	var cy=Math.floor(e.y/tile_y)-(canvas_tile_count-1)/2;
	mouse_pos={x:cx,y:cy}
}
c.onmousedown = function(e){
	update_mouse(e)
    //dragOffset.x = e.x - mainLayer.trans.x;
    //dragOffset.y = e.y - mainLayer.trans.y;
    move_unit(mouse_pos.x,mouse_pos.y,view_dz)
    mouseIsDown = true;
}

c.onmouseup = function(e){

    mouseIsDown = false;
}
/* //TODO issue commands each X time
c.onmousemove = function(e){
    if(!mouseIsDown) return;
    update_mouse(e)
    return false;
}
*/
update_map();
/*
	combat report stuff
*/
var combat_log={last_seen:0,text:[]}
function add_max(a,e,m)
{
	return a.concat(e).slice(-m)
}
function update_log(){
	element=document.getElementById("combat_log_div")
	element.innerHTML=""
	combat_log.text.forEach(function (el) {
		element.innerHTML+=el+"<br>"
	})
}
function get_combat_log(){

	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	if (this.readyState == 4) {
		if(this.status == 200)
		{
			var json_report= JSON.parse(this.responseText);
			combat_log.last_seen=json_report.current_count
			var print_lines=10
			if(json_report.log.length>0)
			{
				combat_log.text=add_max(combat_log.text,json_report.log,print_lines)
				update_log()
			}
		}
		setTimeout(get_combat_log, 200);
	}
	};
	xhttp.open("GET", "get_report_log?last_seen="+combat_log.last_seen, true);
	xhttp.send();
}
get_combat_log()
</script>
<button onclick="location.href = 'new_unit';">Ask for new unit</button> 
<div id="combat_log_div">

</div>


